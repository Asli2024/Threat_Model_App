name: PR Checks

on:
    pull_request:
        branches:
            - main
        paths:
            - "Terraform/**"
            - ".github/workflows/**"

permissions:
    id-token: write
    contents: read
    actions: write

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
    pre-commit:
        name: Pre-commit Checks
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.10.4"

            - name: Cache pre-commit
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pre-commit
                  key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

            - name: Install terraform-docs
              run: |
                  wget -q https://github.com/terraform-docs/terraform-docs/releases/download/v0.20.0/terraform-docs-v0.20.0-linux-amd64.tar.gz
                  tar -xzf terraform-docs-v0.20.0-linux-amd64.tar.gz
                  sudo mv terraform-docs /usr/local/bin/
                  terraform-docs --version

            - name: Install tflint
              run: |
                  curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
                  tflint --version

            - name: Install Trivy
              run: |
                  wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
                  echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
                  sudo apt-get update
                  sudo apt-get install trivy -y
                  trivy --version

            - name: Install pre-commit
              run: |
                  pip install pre-commit
                  pre-commit --version

            - name: Run pre-commit
              run: |
                  pre-commit run --all-files --show-diff-on-failure

    terraform-plan:
        name: Terraform Plan - ${{ matrix.environment }}
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: [pre-commit]
        strategy:
            matrix:
                environment: [dev, staging, prod]
            fail-fast: false

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Configure AWS Credentials via OIDC
              uses: aws-actions/configure-aws-credentials@v5
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/Github_Role_Demo
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Set Up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.10.4"

            - name: Cache Terraform
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.terraform.d/plugin-cache
                      Terraform/.terraform
                  key: terraform-${{ matrix.environment }}-${{ hashFiles('Terraform/**/*.tf') }}
                  restore-keys: |
                      terraform-${{ matrix.environment }}-

            - name: Terraform Init
              working-directory: ./Terraform
              run: |
                  echo "Initializing Terraform..."
                  terraform init

            - name: Terraform Plan (${{ matrix.environment }})
              working-directory: ./Terraform
              run: |
                  echo "Running terraform plan for ${{ matrix.environment }} environment..."
                  terraform workspace select ${{ matrix.environment }} || terraform workspace new ${{ matrix.environment }}
                  terraform plan -var-file=config/${{ matrix.environment }}/${{ matrix.environment }}.tfvars -no-color
