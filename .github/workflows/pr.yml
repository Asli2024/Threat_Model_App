name: PR Checks

on:
    pull_request:
        branches:
            - main
        paths:
            - "Terraform/**"
            - ".github/workflows/**"

permissions:
    id-token: write
    contents: read
    actions: write

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
    pr-checks:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Configure AWS Credentials via OIDC
              uses: aws-actions/configure-aws-credentials@v2
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/Github_Role_Demo
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Set Up Terraform
              uses: hashicorp/setup-terraform@v3

            - name: Terraform Init
              working-directory: ./Terraform
              run: |
                  echo "Initializing Terraform..."
                  terraform init

            - name: Terraform Format Check
              working-directory: ./Terraform
              run: |
                  echo "Running terraform fmt -check -recursive..."
                  terraform fmt -check -recursive

            - name: Terraform Validate
              working-directory: ./Terraform
              run: |
                  echo "Running terraform validate..."
                  terraform validate

            - name: Terraform Plan (Dev)
              working-directory: ./Terraform
              run: |
                  echo "Running terraform plan for dev environment..."
                  terraform workspace select dev || terraform workspace new dev
                  terraform plan -var-file=config/dev/dev.tfvars -no-color

            - name: Install Trivy
              run: |
                  echo "Installing Trivy..."
                  sudo apt-get install wget apt-transport-https gnupg lsb-release -y
                  wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
                  echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
                  sudo apt-get update
                  sudo apt-get install trivy -y
                  trivy --version

            - name: Run Trivy Scan
              working-directory: ./Terraform
              run: |
                  echo "Running Trivy security scan..."
                  trivy config . --exit-code 0 --severity HIGH,CRITICAL
