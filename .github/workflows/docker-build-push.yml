name: Docker Build and Push

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy (dev, staging, prod)"
                required: true
                type: choice
                options:
                    - dev
                    - staging
                    - prod
    push:
        branches:
            - feature*
            - fix*
        paths:
            - "english-dictionary/**"
            - ".github/workflows/docker-build-push.yml"

permissions:
    id-token: write
    contents: read

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
    ECR_REPOSITORY: english-somali-dictionary-app

jobs:
    build-and-push:
        name: Build and Push Docker Image
        runs-on: ubuntu-latest
        timeout-minutes: 20
        outputs:
            image-tag: ${{ steps.image-tag.outputs.tag }}
            image-uri: ${{ steps.image-uri.outputs.uri }}

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure AWS Credentials via OIDC
              uses: aws-actions/configure-aws-credentials@v3
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/Github_Role_Demo
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Determine Image Tag
              id: image-tag
              run: |
                  IMAGE_TAG="${{ github.sha }}"
                  echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
                  echo "Using image tag: ${IMAGE_TAG}"

            - name: Extract Metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}
                  tags: |
                      type=raw,value=${{ steps.image-tag.outputs.tag }}
                      type=raw,value=latest

            - name: Run Trivy Vulnerability Scanner (Dockerfile)
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "config"
                  scan-ref: "english-dictionary/Dockerfile"
                  exit-code: "0"
                  severity: "HIGH,CRITICAL"

            - name: Build and Push Docker Image
              uses: docker/build-push-action@v5
              with:
                  context: ./english-dictionary
                  file: ./english-dictionary/Dockerfile
                  platforms: linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      BUILDKIT_INLINE_CACHE=1

            - name: Image Summary
              id: image-uri
              run: |
                  IMAGE_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}"
                  echo "uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
                  echo "Docker image built and pushed successfully!"
                  echo "Repository: ${{ env.ECR_REPOSITORY }}"
                  echo "Tag: ${{ steps.image-tag.outputs.tag }}"
                  echo "Region: ${{ secrets.AWS_REGION }}"
                  echo "Full Image URI: ${IMAGE_URI}"

    approval:
        name: Approve Deployment - ${{ github.event.inputs.environment }}
        runs-on: ubuntu-latest
        needs: build-and-push
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment != ''
        environment: ${{ github.event.inputs.environment }}

        steps:
            - name: Approval Gate
              run: |
                  echo "Deployment to ${{ github.event.inputs.environment }} approved by ${{ github.actor }}"
                  echo "Image Tag: ${{ needs.build-and-push.outputs.image-tag }}"
                  echo "Proceeding to update ECS service..."

    deploy:
        name: Deploy to ECS - ${{ github.event.inputs.environment }}
        runs-on: ubuntu-latest
        needs: [build-and-push, approval]
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment != ''

        steps:
            - name: Configure AWS Credentials via OIDC
              uses: aws-actions/configure-aws-credentials@v3
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/Github_Role_Demo
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Update ECS Service
              run: |
                  echo "Triggering ECS service update for ${{ github.event.inputs.environment }} environment..."
                  echo "Image: ${{ needs.build-and-push.outputs.image-uri }}"

                  # Force new deployment of ECS service
                  aws ecs update-service \
                    --cluster ${{ github.event.inputs.environment }}-english-somali-dictionary-cluster \
                    --service ${{ github.event.inputs.environment }}-english-somali-dictionary-service \
                    --force-new-deployment \
                    --region ${{ secrets.AWS_REGION }}

                  echo "ECS service update initiated!"

            - name: Deployment Status
              run: |
                  echo "Deployment Summary"
                  echo "Environment: ${{ github.event.inputs.environment }}"
                  echo "Image Tag: ${{ needs.build-and-push.outputs.image-tag }}"
                  echo "Triggered by: ${{ github.actor }}"
                  echo "Timestamp: $(date)"
