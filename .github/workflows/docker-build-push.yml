name: Docker Build and Push

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy (dev, staging, prod)"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
  push:
    branches:
      - main
      - feature*
      - fix*
    paths:
      - "english-dictionary/**"
      - ".github/workflows/docker-build-push.yml"

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: english-somali-dictionary-app

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      image-uri: ${{ steps.image-uri.outputs.uri }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/Github_Role_Demo
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine Image Tag
        id: image-tag
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${IMAGE_TAG}"

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}
          tags: |
            type=raw,value=${{ steps.image-tag.outputs.tag }}

      - name: Run Trivy Vulnerability Scanner (Dockerfile)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "english-dictionary/Dockerfile"
          exit-code: "0"
          severity: "HIGH,CRITICAL"

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./english-dictionary
          file: ./english-dictionary/Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Run Trivy vulnerability scanner on ECR image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "image"
          image-ref: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
        env:
          TRIVY_PLATFORM: "linux/arm64"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Image Summary
        id: image-uri
        run: |
          IMAGE_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}"
          echo "uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "Docker image built and pushed successfully!"
          echo "Repository: ${{ env.ECR_REPOSITORY }}"
          echo "Tag: ${{ steps.image-tag.outputs.tag }}"
          echo "Region: ${{ secrets.AWS_REGION }}"
          echo "Full Image URI: ${IMAGE_URI}"
